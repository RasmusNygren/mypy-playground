<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mypy Playground (WASM)</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; }
    #app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; }
    header, footer { padding: 8px 12px; border-bottom: 1px solid #eee; }
    footer { border-top: 1px solid #eee; border-bottom: none; display:flex; gap:16px; }
    .main { display: grid; grid-template-columns: 1fr 380px; gap: 0; min-height: 0; }
    #editor { min-width: 0; height: calc(100vh - 110px); border-right: 1px solid #eee; }
    #sidebar { display: flex; flex-direction: column; height: calc(100vh - 110px); }
    #controls { padding: 8px; border-bottom: 1px solid #eee; display:flex; gap:8px; align-items:center; }
    #results { padding: 8px; overflow: auto; flex: 1; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .err { border-left: 3px solid #c00; padding-left: 8px; margin: 6px 0; }
    .ok { color: #0a0; }
    button { padding: 6px 10px; }
    select, input[type="checkbox"] { margin-left: 6px; }
  </style>
  <!-- Monaco via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <strong>Mypy Playground (WebAssembly)</strong>
      <span id="status" style="margin-left:10px; opacity:.75;">loadingâ€¦</span>
    </header>

    <div class="main">
      <div id="editor"></div>
      <aside id="sidebar">
        <div id="controls">
          <button id="run">Check</button>
          <label>Python
            <select id="pyver">
              <option>3.12</option><option selected>3.11</option><option>3.10</option><option>3.9</option><option>3.8</option>
            </select>
          </label>
            <label>mypy
              <select id="mypyver">
                <option>1.8.0</option>
                <option>1.9.0</option>
                <option selected>1.10.0</option>
                <option>1.11.2</option>
              </select>
            </label>

          <label>Strict <input id="strict" type="checkbox"></label>
          <label>Ignore missing imports <input id="ignore" type="checkbox" checked></label>
        </div>
        <div id="results" aria-live="polite">Waiting for mypyâ€¦</div>
      </aside>
    </div>

    <footer>
      <div>Tip: Ctrl/Cmd + Enter to type-check â€¢ Debounce 500ms</div>
      <div id="versions" style="margin-left:auto; opacity:.75;"></div>
    </footer>
  </div>

<script type="module">
let editor, worker, ready = false, debounceTimer = null, decorationIds = [];

function setStatus(text){ document.getElementById('status').textContent = text; }

function sanitizeForPath(value) {
  return String(value).replace(/[^a-zA-Z0-9._-]/g, '_');
}

function currentCacheDir() {
  const mypy = sanitizeForPath(document.getElementById('mypyver').value);
  const py = sanitizeForPath(document.getElementById('pyver').value);
  const strict = document.getElementById('strict').checked ? 'strict' : 'nostrict';
  const ignore = document.getElementById('ignore').checked ? 'ignore' : 'noignore';
  return `/tmp/mypy-cache/${mypy}/${py}/${strict}/${ignore}`;
}

function defaultFlags(cacheDirOverride) {
  const flags = ['--no-pretty', '--show-error-codes', '--show-column-numbers',
                 '--hide-error-context', '--no-error-summary', '--follow-imports=skip'];
  if (document.getElementById('strict').checked) flags.push('--strict');
  if (document.getElementById('ignore').checked) flags.push('--ignore-missing-imports');
  const py = document.getElementById('pyver').value;
  flags.push('--python-version', py);
  const cacheDir = cacheDirOverride ?? currentCacheDir();
  flags.push('--cache-dir', cacheDir);
  return flags;
}

function startWorker() {
  if (worker) worker.terminate();
  ready = false;
  setStatus('loadingâ€¦');

  worker = new Worker('mypy-worker.js', { type: 'module' });

  worker.onmessage = (e) => {
    const { type, payload } = e.data;
    if (type === 'init-done') {
      ready = true;
      setStatus('ready');
      const v = payload?.versions || {};
      document.getElementById('versions').textContent =
        `Pyodide ${v.pyodide ?? 'â€”'} â€¢ Python ${v.python ?? 'â€”'} â€¢ mypy ${v.mypy ?? 'â€”'}`;
      worker.postMessage({ type: 'warmup' });
      runCheck();
    } else if (type === 'checking') {
      setStatus('checkingâ€¦');
    } else if (type === 'result') {
      setStatus(`done in ${payload.durationMs} ms`);
      renderDiagnostics(payload);
    } else if (type === 'log') {
      // Optional: surface logs somewhere if you want
      console.log('[worker]', payload);
    } else if (type === 'error') {
      setStatus('error');
      document.getElementById('results').innerHTML =
        `<div class="err">Worker error: ${payload}</div>`;
    }
  };

  worker.postMessage({
    type: 'init',
    payload: {
      mypyVersion: document.getElementById('mypyver').value,
      mypyFlags: defaultFlags(currentCacheDir()),
      cacheDir: currentCacheDir()
    }
  });
}

function runCheck() {
  if (!ready) return;
  const code = editor.getValue();
  const cacheDir = currentCacheDir();
  worker.postMessage({
    type: 'check',
    payload: {
      filename: 'snippet.py',
      code,
      mypyFlags: defaultFlags(cacheDir),
      cacheDir
    }
  });
}

function renderDiagnostics({ diagnostics, text }) {
  const res = document.getElementById('results');
  const list = Array.isArray(diagnostics) ? diagnostics : [];

  if (list.length === 0) {
    res.innerHTML = `<div class="ok">Success: no issues found</div>`;
  } else {
    const itemsHtml = list.map(d => {
      const codeLabel = d.code ? ` <code>[${escapeHtml(d.code)}]</code>` : '';
      const pos = `${escapeHtml(d.file)}:${d.line}${d.column ? ':' + d.column : ''}`;
      return `
        <div class="err">
          <div><strong>${pos}</strong>${codeLabel}</div>
          <div>${escapeHtml(d.message)}</div>
        </div>
      `;
    }).join('');
    res.innerHTML = itemsHtml;

    const details = document.createElement('details');
    details.innerHTML = `<summary>Raw mypy output</summary><pre>${escapeHtml(text || '')}</pre>`;
    res.appendChild(details);
  }

  const newDecorations = list.map(d => ({
    range: new monaco.Range(
      d.line,
      Math.max(d.column || 1, 1),
      d.line,
      Math.max((d.column || 1) + 1, 2)
    ),
    options: {
      inlineClassName: 'squiggle-error',
      glyphMarginClassName: 'glyph-error',
      glyphMarginHoverMessage: { value:
        `${escapeHtml(d.message)}${d.code ? ' [' + escapeHtml(d.code) + ']' : ''}` }
    }
  }));
  decorationIds = editor.deltaDecorations(decorationIds, newDecorations);
}

function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// Monaco boot + UI wiring (unchanged aside from the new dropdown listener)
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
require(['vs/editor/editor.main'], () => {
  editor = monaco.editor.create(document.getElementById('editor'), {
    value: `# Try changing "mypy" and "Python" versions in the right panel\nfrom typing import List\n\ndef greet(name: str) -> str:\n    return "hi " + name\n\nx: List[int] = ["oops"]\nprint(greet(123))\n`,
    language: 'python',
    automaticLayout: true,
    minimap: { enabled: false },
    fontLigatures: true
  });

  // Start worker for the initial version
  startWorker();

  document.getElementById('run').addEventListener('click', runCheck);
  document.getElementById('pyver').addEventListener('change', runCheck);
  document.getElementById('strict').addEventListener('change', runCheck);
  document.getElementById('ignore').addEventListener('change', runCheck);

  // ðŸ”„ Recreate worker when mypy version changes
  document.getElementById('mypyver').addEventListener('change', () => {
    startWorker();
  });

  editor.onDidChangeModelContent(() => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(runCheck, 500);
  });

  window.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') runCheck();
  });
});
</script>
</body>
</html>
